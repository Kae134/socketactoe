{"version":3,"sources":["../../../../../packages/vite/src/utils/vite-config-edit-utils.ts"],"sourcesContent":["import { applyChangesToString, ChangeType, Tree } from '@nx/devkit';\nimport { findNodes } from '@nx/js';\nimport { TargetFlags } from './generator-utils';\nimport type {\n  ArrayLiteralExpression,\n  Node,\n  PropertyAssignment,\n  ReturnStatement,\n} from 'typescript';\n\nexport function ensureViteConfigIsCorrect(\n  tree: Tree,\n  path: string,\n  buildConfigString: string,\n  buildConfigObject: {},\n  imports: string[],\n  plugins: string[],\n  testConfigString: string,\n  testConfigObject: {},\n  cacheDir: string,\n  projectAlreadyHasViteTargets?: TargetFlags\n): boolean {\n  const fileContent = tree.read(path, 'utf-8');\n\n  let updatedContent = undefined;\n\n  if (!projectAlreadyHasViteTargets?.test && testConfigString?.length) {\n    updatedContent = handleBuildOrTestNode(\n      fileContent,\n      testConfigString,\n      testConfigObject,\n      'test'\n    );\n  }\n\n  if (!projectAlreadyHasViteTargets?.build && buildConfigString?.length) {\n    updatedContent = handleBuildOrTestNode(\n      updatedContent ?? fileContent,\n      buildConfigString,\n      buildConfigObject,\n      'build'\n    );\n  }\n\n  updatedContent =\n    handlePluginNode(updatedContent ?? fileContent, imports, plugins) ??\n    updatedContent;\n\n  if (cacheDir?.length) {\n    updatedContent = handleCacheDirNode(\n      updatedContent ?? fileContent,\n      cacheDir\n    );\n  }\n\n  if (updatedContent) {\n    tree.write(path, updatedContent);\n    return true;\n  } else {\n    return false;\n  }\n}\n\nfunction handleBuildOrTestNode(\n  updatedFileContent: string,\n  configContentString: string,\n  configContentObject: {},\n  name: 'build' | 'test'\n): string | undefined {\n  const { tsquery } = require('@phenomnomnominal/tsquery');\n  const buildOrTestNode = tsquery.query(\n    updatedFileContent,\n    `PropertyAssignment:has(Identifier[name=\"${name}\"])`\n  );\n\n  if (buildOrTestNode.length) {\n    return tsquery.replace(\n      updatedFileContent,\n      `PropertyAssignment:has(Identifier[name=\"${name}\"])`,\n      (node: PropertyAssignment) => {\n        const existingProperties = tsquery.query(\n          node.initializer,\n          'PropertyAssignment'\n        ) as PropertyAssignment[];\n        let updatedPropsString = '';\n        for (const prop of existingProperties) {\n          const propName = prop.name.getText();\n          if (\n            !configContentObject[propName] &&\n            propName !== 'dir' &&\n            propName !== 'reportsDirectory' &&\n            propName !== 'provider'\n          ) {\n            updatedPropsString += `'${propName}': ${prop.initializer.getText()},\\n`;\n          }\n        }\n        for (const [propName, propValue] of Object.entries(\n          configContentObject\n        )) {\n          updatedPropsString += `'${propName}': ${JSON.stringify(\n            propValue\n          )},\\n`;\n        }\n        return `${name}: {\n          ${updatedPropsString}\n        }`;\n      }\n    );\n  } else {\n    const foundDefineConfig = tsquery.query(\n      updatedFileContent,\n      'CallExpression:has(Identifier[name=\"defineConfig\"])'\n    );\n\n    if (foundDefineConfig.length) {\n      const conditionalConfig = tsquery.query(\n        foundDefineConfig[0],\n        'ArrowFunction'\n      );\n\n      if (conditionalConfig.length) {\n        if (name === 'build') {\n          return transformConditionalConfig(\n            conditionalConfig,\n            updatedFileContent,\n            configContentString\n          );\n        } else {\n          // no test config in conditional config\n          return updatedFileContent;\n        }\n      } else {\n        const propertyAssignments = tsquery.query(\n          foundDefineConfig[0],\n          'PropertyAssignment'\n        );\n\n        if (propertyAssignments.length) {\n          return applyChangesToString(updatedFileContent, [\n            {\n              type: ChangeType.Insert,\n              index: propertyAssignments[0].getStart(),\n              text: configContentString,\n            },\n          ]);\n        } else {\n          return applyChangesToString(updatedFileContent, [\n            {\n              type: ChangeType.Insert,\n              index: foundDefineConfig[0].getStart() + 14,\n              text: configContentString,\n            },\n          ]);\n        }\n      }\n    } else {\n      // build config does not exist and defineConfig is not used\n      // could also potentially be invalid syntax, so try-catch\n      try {\n        const defaultExport = tsquery.query(\n          updatedFileContent,\n          'ExportAssignment'\n        );\n        const found = tsquery.query(\n          defaultExport?.[0],\n          'ObjectLiteralExpression'\n        );\n        const startOfObject = found?.[0].getStart();\n        return applyChangesToString(updatedFileContent, [\n          {\n            type: ChangeType.Insert,\n            index: startOfObject + 1,\n            text: configContentString,\n          },\n        ]);\n      } catch {\n        return updatedFileContent;\n      }\n    }\n  }\n}\n\nfunction transformCurrentBuildObject(\n  index: number,\n  returnStatements: ReturnStatement[],\n  appFileContent: string,\n  buildConfigObject: {}\n): string | undefined {\n  if (!returnStatements?.[index]) {\n    return undefined;\n  }\n  const { tsquery } = require('@phenomnomnominal/tsquery');\n  const currentBuildObject = tsquery\n    .query(returnStatements[index], 'ObjectLiteralExpression')?.[0]\n    .getText();\n\n  const currentBuildObjectStart = returnStatements[index].getStart();\n  const currentBuildObjectEnd = returnStatements[index].getEnd();\n  const newReturnObject = tsquery.replace(\n    returnStatements[index].getText(),\n    'ObjectLiteralExpression',\n    (_node: Node) => {\n      return `{\n        ...${currentBuildObject},\n        ...${JSON.stringify(buildConfigObject)}\n      }`;\n    }\n  );\n\n  const newContents = applyChangesToString(appFileContent, [\n    {\n      type: ChangeType.Delete,\n      start: currentBuildObjectStart,\n      length: currentBuildObjectEnd - currentBuildObjectStart,\n    },\n    {\n      type: ChangeType.Insert,\n      index: currentBuildObjectStart,\n      text: newReturnObject,\n    },\n  ]);\n\n  return newContents;\n}\n\nfunction transformConditionalConfig(\n  conditionalConfig: Node[],\n  appFileContent: string,\n  buildConfigObject: {}\n): string | undefined {\n  const { tsquery } = require('@phenomnomnominal/tsquery');\n  const { SyntaxKind } = require('typescript');\n  const functionBlock = tsquery.query(conditionalConfig[0], 'Block');\n  const ifStatement = tsquery.query(functionBlock?.[0], 'IfStatement');\n\n  const binaryExpressions = tsquery.query(ifStatement?.[0], 'BinaryExpression');\n\n  const buildExists = binaryExpressions?.find(\n    (binaryExpression) => binaryExpression.getText() === `command === 'build'`\n  );\n\n  const buildExistsExpressionIndex = binaryExpressions?.findIndex(\n    (binaryExpression) => binaryExpression.getText() === `command === 'build'`\n  );\n\n  const serveExists = binaryExpressions?.find(\n    (binaryExpression) => binaryExpression.getText() === `command === 'serve'`\n  );\n\n  const elseKeywordExists = findNodes(ifStatement?.[0], SyntaxKind.ElseKeyword);\n  const returnStatements: ReturnStatement[] = tsquery.query(\n    ifStatement[0],\n    'ReturnStatement'\n  );\n\n  if (!buildExists) {\n    if (serveExists && elseKeywordExists) {\n      // build options live inside the else block\n      return (\n        transformCurrentBuildObject(\n          returnStatements?.length - 1,\n          returnStatements,\n          appFileContent,\n          buildConfigObject\n        ) ?? appFileContent\n      );\n    } else {\n      // no build options exist yet\n      const functionBlockStart = functionBlock?.[0].getStart();\n      const newContents = applyChangesToString(appFileContent, [\n        {\n          type: ChangeType.Insert,\n          index: functionBlockStart + 1,\n          text: `\n            if (command === 'build') {\n              return ${JSON.stringify(buildConfigObject)}\n            }\n            `,\n        },\n      ]);\n      return newContents;\n    }\n  } else {\n    // build already exists\n    // it will be the return statement which lives\n    // at the buildExistsExpressionIndex\n\n    return (\n      transformCurrentBuildObject(\n        buildExistsExpressionIndex,\n        returnStatements,\n        appFileContent,\n        buildConfigObject\n      ) ?? appFileContent\n    );\n  }\n}\n\nfunction handlePluginNode(\n  appFileContent: string,\n  imports: string[],\n  plugins: string[]\n): string | undefined {\n  const { tsquery } = require('@phenomnomnominal/tsquery');\n  const file = tsquery.ast(appFileContent);\n  const pluginsNode = tsquery.query(\n    file,\n    'PropertyAssignment:has(Identifier[name=\"plugins\"])'\n  );\n\n  let writeFile = false;\n\n  if (pluginsNode.length) {\n    appFileContent = tsquery.replace(\n      file.getText(),\n      'PropertyAssignment:has(Identifier[name=\"plugins\"])',\n      (node: Node) => {\n        const found = tsquery.query(\n          node,\n          'ArrayLiteralExpression'\n        ) as ArrayLiteralExpression[];\n        let updatedPluginsString = '';\n\n        const existingPluginNodes = found?.[0].elements ?? [];\n\n        for (const plugin of existingPluginNodes) {\n          updatedPluginsString += `${plugin.getText()},\\n`;\n        }\n\n        for (const plugin of plugins) {\n          if (\n            !existingPluginNodes?.some((node) =>\n              node.getText().includes(plugin)\n            )\n          ) {\n            updatedPluginsString += `${plugin},\\n`;\n          }\n        }\n\n        return `plugins: [${updatedPluginsString}]`;\n      }\n    );\n    writeFile = true;\n  } else {\n    // Plugins node does not exist yet\n    // So make one from scratch\n\n    const foundDefineConfig = tsquery.query(\n      file,\n      'CallExpression:has(Identifier[name=\"defineConfig\"])'\n    );\n\n    if (foundDefineConfig.length) {\n      const conditionalConfig = tsquery.query(\n        foundDefineConfig[0],\n        'ArrowFunction'\n      );\n\n      if (conditionalConfig.length) {\n        // We are NOT transforming the conditional config\n        // with plugins\n        writeFile = false;\n      } else {\n        const propertyAssignments = tsquery.query(\n          foundDefineConfig[0],\n          'PropertyAssignment'\n        );\n\n        if (propertyAssignments.length) {\n          appFileContent = applyChangesToString(appFileContent, [\n            {\n              type: ChangeType.Insert,\n              index: propertyAssignments[0].getStart(),\n              text: `plugins: [${plugins.join(',\\n')}],`,\n            },\n          ]);\n          writeFile = true;\n        } else {\n          appFileContent = applyChangesToString(appFileContent, [\n            {\n              type: ChangeType.Insert,\n              index: foundDefineConfig[0].getStart() + 14,\n              text: `plugins: [${plugins.join(',\\n')}],`,\n            },\n          ]);\n          writeFile = true;\n        }\n      }\n    } else {\n      // Plugins option does not exist and defineConfig is not used\n      // could also potentially be invalid syntax, so try-catch\n      try {\n        const defaultExport = tsquery.query(file, 'ExportAssignment');\n        const found = tsquery?.query(\n          defaultExport?.[0],\n          'ObjectLiteralExpression'\n        );\n        const startOfObject = found?.[0].getStart();\n        appFileContent = applyChangesToString(appFileContent, [\n          {\n            type: ChangeType.Insert,\n            index: startOfObject + 1,\n            text: `plugins: [${plugins.join(',\\n')}],`,\n          },\n        ]);\n        writeFile = true;\n      } catch {\n        writeFile = false;\n      }\n    }\n  }\n  if (writeFile) {\n    const filteredImports = filterImport(appFileContent, imports);\n    return filteredImports.join(';') + '\\n' + appFileContent;\n  }\n}\n\nfunction filterImport(appFileContent: string, imports: string[]): string[] {\n  const { tsquery } = require('@phenomnomnominal/tsquery');\n  const file = tsquery.ast(appFileContent);\n  const importNodes = tsquery.query(\n    file,\n    ':matches(ImportDeclaration, VariableStatement)'\n  );\n\n  const importsArrayExisting = importNodes?.map((node) => {\n    return node.getText().slice(0, -1);\n  });\n\n  return imports.filter((importString) => {\n    return !importsArrayExisting?.includes(importString);\n  });\n}\n\nfunction handleCacheDirNode(appFileContent: string, cacheDir: string): string {\n  const { tsquery } = require('@phenomnomnominal/tsquery');\n\n  const file = tsquery.ast(appFileContent);\n  const cacheDirNode = tsquery.query(\n    file,\n    'PropertyAssignment:has(Identifier[name=\"cacheDir\"])'\n  );\n\n  if (!cacheDirNode?.length || cacheDirNode?.length === 0) {\n    // cacheDir node does not exist yet\n    // So make one from scratch\n\n    const foundDefineConfig = tsquery.query(\n      file,\n      'CallExpression:has(Identifier[name=\"defineConfig\"])'\n    );\n\n    if (foundDefineConfig.length) {\n      const conditionalConfig = tsquery.query(\n        foundDefineConfig[0],\n        'ArrowFunction'\n      );\n\n      if (conditionalConfig.length) {\n        // We are NOT transforming the conditional config\n        // with cacheDir\n      } else {\n        const propertyAssignments = tsquery.query(\n          foundDefineConfig[0],\n          'PropertyAssignment'\n        );\n\n        if (propertyAssignments.length) {\n          appFileContent = applyChangesToString(appFileContent, [\n            {\n              type: ChangeType.Insert,\n              index: propertyAssignments[0].getStart(),\n              text: cacheDir,\n            },\n          ]);\n        } else {\n          appFileContent = applyChangesToString(appFileContent, [\n            {\n              type: ChangeType.Insert,\n              index: foundDefineConfig[0].getStart() + 14,\n              text: cacheDir,\n            },\n          ]);\n        }\n      }\n    } else {\n      // cacheDir option does not exist and defineConfig is not used\n      // could also potentially be invalid syntax, so try-catch\n      try {\n        const defaultExport = tsquery.query(file, 'ExportAssignment');\n        const found = tsquery?.query(\n          defaultExport?.[0],\n          'ObjectLiteralExpression'\n        );\n        const startOfObject = found?.[0].getStart();\n        appFileContent = applyChangesToString(appFileContent, [\n          {\n            type: ChangeType.Insert,\n            index: startOfObject + 1,\n            text: cacheDir,\n          },\n        ]);\n      } catch {}\n    }\n  }\n\n  return appFileContent;\n}\n"],"names":["ensureViteConfigIsCorrect","tree","path","buildConfigString","buildConfigObject","imports","plugins","testConfigString","testConfigObject","cacheDir","projectAlreadyHasViteTargets","fileContent","read","updatedContent","undefined","test","length","handleBuildOrTestNode","build","handlePluginNode","handleCacheDirNode","write","updatedFileContent","configContentString","configContentObject","name","tsquery","require","buildOrTestNode","query","replace","node","existingProperties","initializer","updatedPropsString","prop","propName","getText","propValue","Object","entries","JSON","stringify","foundDefineConfig","conditionalConfig","transformConditionalConfig","propertyAssignments","applyChangesToString","type","ChangeType","Insert","index","getStart","text","defaultExport","found","startOfObject","transformCurrentBuildObject","returnStatements","appFileContent","currentBuildObject","currentBuildObjectStart","currentBuildObjectEnd","getEnd","newReturnObject","_node","newContents","Delete","start","SyntaxKind","functionBlock","ifStatement","binaryExpressions","buildExists","find","binaryExpression","buildExistsExpressionIndex","findIndex","serveExists","elseKeywordExists","findNodes","ElseKeyword","functionBlockStart","file","ast","pluginsNode","writeFile","updatedPluginsString","existingPluginNodes","elements","plugin","some","includes","join","filteredImports","filterImport","importNodes","importsArrayExisting","map","slice","filter","importString","cacheDirNode"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}